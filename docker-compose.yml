secrets:
  postgres_password:
    file: ./secrets/postgres_password.txt
  jwt_secret:
    file: ./secrets/jwt_secret.txt
  fabric_ca_password:
    file: ./secrets/fabric_ca_password.txt
  encryption_key:
    file: ./secrets/encryption_key.txt
  service_token:
    file: ./secrets/service_token.txt

services:
  postgres:
    image: postgres:15
    container_name: block_postgres
    restart: unless-stopped
    secrets:
      - postgres_password
    environment:
      POSTGRES_USER: gateway_user
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
      POSTGRES_DB: blockchain_gateway
      POSTGRES_MULTIPLE_DATABASES: blockchain_gateway,gateway_db
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d blockchain_gateway"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - block-net

  redis:
    image: redis:7-alpine
    container_name: block_redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - block-net

  backend:
    build:
      context: ./backend
    container_name: block_backend
    restart: unless-stopped
    secrets:
      - postgres_password
      - jwt_secret
      - encryption_key
      - fabric_ca_password
      - service_token
    env_file:
      - ./backend/.env
    environment:
      # Use Docker secrets (read from files in /run/secrets/)
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
      SECRET_KEY_FILE: /run/secrets/jwt_secret
      ENCRYPTION_KEY_FILE: /run/secrets/encryption_key
      FABRIC_CA_ADMIN_PASSWORD_FILE: /run/secrets/fabric_ca_password
      SERVICE_TOKEN_FILE: /run/secrets/service_token
      # Database URLs will be built from secrets in app config
      REDIS_URL: redis://redis:6379/0
      # CORS: Allow frontend, API Gateway, and development origins
      BACKEND_CORS_ORIGINS: http://localhost:3000,http://localhost:4000,http://localhost:8000,http://frontend,http://api-gateway
      # Fabric CA TLS certificate paths
      FABRIC_CA_ORG1_TLS_CERT: /fabric-ca-certs/org1-tls-cert.pem
      FABRIC_CA_ORDERER_TLS_CERT: /fabric-ca-certs/orderer-tls-cert.pem
    volumes:
      - ./backend:/app
      - ./uploads:/app/uploads
      # Mount Fabric CA TLS certificates for secure communication
      - ./ibn-core/organizations/fabric-ca/org1/tls-cert.pem:/fabric-ca-certs/org1-tls-cert.pem:ro
      - ./ibn-core/organizations/fabric-ca/ordererOrg/tls-cert.pem:/fabric-ca-certs/orderer-tls-cert.pem:ro
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "8000:8000"
    networks:
      - block-net
      - fabric-network  # Need access to Fabric CA containers

  api-gateway:
    build:
      context: ./gateway/api-gateway
    container_name: block_api_gateway
    restart: unless-stopped
    env_file:
      - ./gateway/api-gateway/.env
    environment:
      PORT: 3000
      BACKEND_BASE_URL: http://backend:8000
      FABRIC_GATEWAY_URL: http://fabric-gateway:3001
      REDIS_URL: redis://redis:6379/0
      NODE_ENV: production
      # CORS origins - allow frontend
      CORS_ORIGINS: http://localhost:3000,http://localhost:4000,http://frontend
    volumes:
      - ./gateway/api-gateway/logs:/app/logs
      - ./gateway/api-gateway/src:/app/src  # For development hot reload
    depends_on:
      backend:
        condition: service_healthy  # Wait for backend to be healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s  # Give more time for backend connection
    ports:
      - "4000:3000"
    networks:
      - block-net

  fabric-gateway:
    build:
      context: ./gateway/fabric-gateway
    container_name: block_fabric_gateway
    restart: unless-stopped  # Auto-restart on failure
    env_file:
      - ./gateway/fabric-gateway/.env
    environment:
      FABRIC_GATEWAY_PORT: 3001
      FABRIC_CA_URL: http://ca-org1:8054
      FABRIC_AS_LOCALHOST: "false"
      FABRIC_NETWORK_CONFIG_PATH: /app/crypto
      FABRIC_CHANNEL_NAME: ibnchannel
      FABRIC_CHAINCODE_NAME: basic
      FABRIC_MSP_ID: Org1MSP
      FABRIC_IDENTITY: User1@org1.example.com
    volumes:
      - ./gateway/fabric-gateway/crypto:/app/crypto:ro
      - ./gateway/fabric-gateway/wallet:/app/wallet
      - ./gateway/fabric-gateway/logs:/app/logs
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      - backend
    ports:
      - "3001:3001"
    networks:
      - block-net
      - fabric-network
    profiles:
      - with-fabric

  frontend:
    build:
      context: ./frontend
    container_name: block_frontend
    restart: unless-stopped
    # Note: Environment variables below have NO EFFECT for production build!
    # React app is built during 'docker build', not at container runtime.
    # To change API URLs, edit frontend/src/services/api.ts and rebuild.
    # These are kept for documentation purposes only.
    environment:
      # API_URL is hardcoded in built JS: http://localhost:4000/api/v1
      # WS_URL is hardcoded in built JS: http://localhost:8000
      # FABRIC_URL is hardcoded in built JS: http://localhost:3001
      INFO_API_GATEWAY: http://api-gateway:3000
      INFO_BACKEND: http://backend:8000
      INFO_FABRIC: http://fabric-gateway:3001
    depends_on:
      api-gateway:
        condition: service_healthy  # Wait for API Gateway to be ready
      backend:
        condition: service_healthy
    ports:
      - "3000:80"
    networks:
      - block-net

volumes:
  postgres-data:
  redis-data:

networks:
  block-net:
    driver: bridge
  fabric-network:
    external: true
    name: fabric-network

