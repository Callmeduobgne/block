# Backend Phase 3 - Development Docker Compose
version: '3.8'

networks:
  backend-network:
    driver: bridge
  fabric-network:
    external: true

volumes:
  postgres_data:
  redis_data:

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: backend-postgres-dev
    environment:
      POSTGRES_DB: blockchain_gateway_dev
      POSTGRES_USER: gateway_user
      POSTGRES_PASSWORD: gateway_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - backend-network
    restart: unless-stopped

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: backend-redis-dev
    ports:
      - "6379:6379"
    networks:
      - backend-network
    restart: unless-stopped

  # Backend API (Development)
  backend:
    build: .
    container_name: backend-api-dev
    environment:
      # Database Configuration
      DATABASE_URL: postgresql://gateway_user:gateway_password@postgres:5432/blockchain_gateway_dev
      DATABASE_URL_ASYNC: postgresql+asyncpg://gateway_user:gateway_password@postgres:5432/blockchain_gateway_dev
      
      # Redis Configuration
      REDIS_URL: redis://redis:6379/0
      
      # JWT Configuration
      SECRET_KEY: dev-secret-key-change-in-production
      ALGORITHM: HS256
      ACCESS_TOKEN_EXPIRE_MINUTES: 30
      REFRESH_TOKEN_EXPIRE_DAYS: 7
      
      # API Configuration
      API_V1_STR: /api/v1
      PROJECT_NAME: Blockchain Gateway Backend Dev
      VERSION: 3.0.0-dev
      DEBUG: "true"
      
      # CORS Configuration
      BACKEND_CORS_ORIGINS: '["http://localhost:3000", "http://localhost:3001", "http://localhost:4000"]'
      
      # Gateway Integration
      GATEWAY_URL: http://localhost:3001
      GATEWAY_TIMEOUT: 30
      
      # Fabric CA Configuration
      FABRIC_CA_URL: http://localhost:7054
      FABRIC_CA_ADMIN_USERNAME: admin
      FABRIC_CA_ADMIN_PASSWORD: adminpw
      FABRIC_CA_TLS_ENABLED: "false"
      
      # File Upload Configuration
      MAX_FILE_SIZE: 10485760
      UPLOAD_DIRECTORY: ./uploads
      ALLOWED_EXTENSIONS: .go,.java,.js,.ts
      
      # Logging Configuration
      LOG_LEVEL: DEBUG
      LOG_FORMAT: json
      LOG_FILE: ./logs/backend.log
      
      # Monitoring
      ENABLE_METRICS: "true"
      METRICS_PORT: 9090
      
      # Security
      BCRYPT_ROUNDS: 12
      PASSWORD_MIN_LENGTH: 8
    ports:
      - "4000:4000"
    volumes:
      - .:/app
      - ./logs:/app/logs
      - ./uploads:/app/uploads
    networks:
      - backend-network
    depends_on:
      - postgres
      - redis
    command: uvicorn app.main:app --host 0.0.0.0 --port 4000 --reload
    restart: unless-stopped
